<!DOCTYPE html>
<html>
<head>
    <title>Phaser Racer Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #error {
            color: white;
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            font-family: Arial;
        }
    </style>
</head>
<body>
    <div id="error"></div>
    <script>
        const config = {
            type: Phaser.AUTO,
            width: 900,
            height: 700,
            physics: {
                default: 'matter', // Switch to Matter.js for better physics
                matter: {
                    gravity: { y: 0 },
                    debug: false
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        const game = new Phaser.Game(config);
        let car, cursors;
        let trackGraphics;
        
        // Enhanced track configuration
        const trackConfig = {
            outer: { x: 450, y: 350, width: 600, height: 500, radius: 50 },
            inner: { x: 450, y: 350, width: 400, height: 300, radius: 30 },
            roadTexture: 'road',
            grassTexture: 'grass',
            checkeredTexture: 'checkered'
        };

        function preload() {
            this.load.image('car', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAjCAYAAABvR7Y6AAAABmJLR0QA/wD/AP+AdzggAAAAtUlEQVRIx2P4DwQYGPg/oP/v37/vP7/7N0yAhkGGYVhw4CAzMP0DA+MPGhpGA0jA8AwMDB9m/3///j9wMQYGBq4MDAz/h4H7+Q8QJgx4/w8DAwMDD+fPfx+wMTAwMPIwMDD8P31gwPDv/wMMDAxg/Pz+gZGBAR/2vP+BgeG/s/T/oJGhgaGDkYGB4R8GBgb2f2BiYGBgYMDAwMBiQzUoGwY4DAwMWBgYAAB111V0xW5+76gAAAABJRU5ErkJggg==');
            this.load.image('road', '__WHITE');
            this.load.image('grass', '__BLACK');
            this.load.image('checkered', '__WHITE');
        }

        function create() {
            // Add debug text
            this.debugText = this.add.text(10, 10, '', { font: '16px Arial', fill: '#fff' });
            
            // Create track with collision
            createTrack();
            
            // Create car with physics body
            car = this.matter.add.image(450, 600, 'car')
                .setAngle(-90)
                .setScale(0.5)
                .setFriction(0.05)
                .setBounce(0.2)
                .setDensity(0.01);

            // Car physics properties
            car.setFixedRotation(false);
            car.setAngularVelocity(0);
            car.setMass(30);

            // Set up controls
            cursors = this.input.keyboard.createCursorKeys();
            
            // Enable physics debugging
            this.matter.world.drawDebug = true;
            
            // Camera follow
            this.cameras.main.startFollow(car);
            this.cameras.main.setZoom(1.2);
            
            // Add particle effect for engine
            this.particles = this.add.particles('checkered');
            this.emitter = this.particles.createEmitter({
                speed: 100,
                scale: { start: 0.5, end: 0 },
                blendMode: 'ADD',
                follow: car
            }).stop();
        }

        function createTrack() {
            // Simple green background
            this.add.rectangle(450, 350, 900, 700, 0x228B22);
            
            // Draw visible track boundaries
            const track = this.add.graphics()
                .fillStyle(0x444444)
                .fillRoundedRect(
                    trackConfig.outer.x - trackConfig.outer.width/2,
                    trackConfig.outer.y - trackConfig.outer.height/2,
                    trackConfig.outer.width,
                    trackConfig.outer.height,
                    trackConfig.outer.radius
                )
                .fillStyle(0x228B22)
                .fillRoundedRect(
                    trackConfig.inner.x - trackConfig.inner.width/2,
                    trackConfig.inner.y - trackConfig.inner.height/2,
                    trackConfig.inner.width,
                    trackConfig.inner.height,
                    trackConfig.inner.radius
                );

            // Enable physics on track boundaries
            this.matter.add.gameObject(track, {
                shape: {
                    type: 'fromVerts',
                    verts: [
                        { x: trackConfig.outer.x - trackConfig.outer.width/2, y: trackConfig.outer.y - trackConfig.outer.height/2 },
                        { x: trackConfig.outer.x + trackConfig.outer.width/2, y: trackConfig.outer.y - trackConfig.outer.height/2 },
                        { x: trackConfig.outer.x + trackConfig.outer.width/2, y: trackConfig.outer.y + trackConfig.outer.height/2 },
                        { x: trackConfig.outer.x - trackConfig.outer.width/2, y: trackConfig.outer.y + trackConfig.outer.height/2 }
                    ]
                },
                isStatic: true
            });
        }

        function drawTrackGeometry() {
            // Draw textured track
            trackLayer
                .fillStyle(0xffffff)
                .fillRoundedRect(
                    trackConfig.outer.x - trackConfig.outer.width/2,
                    trackConfig.outer.y - trackConfig.outer.height/2,
                    trackConfig.outer.width,
                    trackConfig.outer.height,
                    trackConfig.outer.radius
                )
                .fillStyle(0x228B22)
                .fillRoundedRect(
                    trackConfig.inner.x - trackConfig.inner.width/2,
                    trackConfig.inner.y - trackConfig.inner.height/2,
                    trackConfig.inner.width,
                    trackConfig.inner.height,
                    trackConfig.inner.radius
                );
        }

        function update() {
            // Update debug text
            this.debugText.setText([
                `Position: ${Math.round(car.x)}, ${Math.round(car.y)}`,
                `Speed: ${Math.round(car.speed)}`,
                `Rotation: ${Math.round(car.angle)}Â°`
            ].join('\n'));
            
            // Enhanced controls with analog input
            const acceleration = cursors.up.isDown ? 0.15 : cursors.down.isDown ? -0.1 : 0;
            const steering = cursors.left.isDown ? -0.08 : cursors.right.isDown ? 0.08 : 0;
            
            // Apply forces
            this.matter.applyForceFromAngle(car, acceleration * car.mass, car.rotation);
            
            // Steering with speed-dependent response
            const turnRate = Phaser.Math.Clamp(car.speed * 0.002, 0.002, 0.01);
            car.setAngularVelocity(steering * turnRate * 1000);

            // Particle effects
            if (Math.abs(car.angularVelocity) > 0.5 || car.speed > 150) {
                this.emitter.start();
            } else {
                this.emitter.stop();
            }

            // Track friction effects
            const body = car.body;
            if (body) {
                const velocity = body.velocity;
                const speed = Math.sqrt(velocity.x ** 2 + velocity.y ** 2);
                const friction = speed > 100 ? 0.1 : 0.02;
                body.friction = friction;
                body.frictionAir = 0.01;
            }
        }
    </script>
</body>
</html>
