<!DOCTYPE html>
<html>
<head>
    <title>Phaser Racer Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
    </style>
</head>
<body>
    <script>
        window.onload = function() {
            // --- GAME CONFIGURATION ---
            const config = {
                type: Phaser.AUTO,
                width: 900,
                height: 700,
                physics: {
                    default: 'matter',
                    matter: {
                        gravity: { y: 0 },
                        debug: false
                    }
                },
                scene: {
                    preload: preload,
                    create: create,
                    update: update
                }
            };

            // --- GLOBAL VARIABLES ---
            const game = new Phaser.Game(config);
            let car, cursors;
            const trackConfig = {
                outer: new Phaser.Geom.Rectangle(150, 100, 600, 500),
                inner: new Phaser.Geom.Rectangle(250, 200, 400, 300)
            };
            const normalFriction = 0.05;
            const grassFriction = 0.3;

            // --- SCENE FUNCTIONS ---
            function preload() {
                let carGraphics = this.make.graphics({x: 0, y: 0, add: false});

                // --- Draw elements from back to front (bottom layer to top layer) ---

                // Rear Wheels (black squares)
                carGraphics.fillStyle(0x111111);
                carGraphics.fillRect(5, 0, 8, 5);   // Rear right
                carGraphics.fillRect(5, 25, 8, 5);  // Rear left

                // Rear Axle (black rectangle)
                carGraphics.fillRect(8, 2, 2, 26); // Connecting rear wheels

                // Front Wheels (black squares)
                carGraphics.fillRect(45, 0, 8, 5);  // Front right
                carGraphics.fillRect(45, 25, 8, 5); // Front left

                // Front Axle (black rectangle)
                carGraphics.fillRect(48, 2, 2, 26); // Connecting front wheels

                // Rear Spoiler Supports (black rectangles)
                carGraphics.fillRect(0, 8, 2, 4);   // Left support
                carGraphics.fillRect(0, 18, 2, 4);  // Right support

                // Rear Spoiler (black rectangle)
                carGraphics.fillRect(0, 10, 5, 10); // Wider spoiler

                // Main Body (red rectangle)
                carGraphics.fillStyle(0xff0000);
                carGraphics.fillRect(15, 5, 30, 20); // Long, narrow body

                // Sidepods (red rectangles)
                carGraphics.fillRect(20, 0, 10, 5); // Left sidepod
                carGraphics.fillRect(20, 25, 10, 5); // Right sidepod

                // Nose (red triangle)
                carGraphics.beginPath();
                carGraphics.moveTo(45, 5);  // Base top
                carGraphics.lineTo(55, 15); // Pointy tip
                carGraphics.lineTo(45, 25); // Base bottom
                carGraphics.closePath();
                carGraphics.fillPath();

                // Front Wing (black rectangle)
                carGraphics.fillStyle(0x111111);
                carGraphics.fillRect(50, 0, 10, 30); // Wide front wing

                // Cockpit (black circle)
                carGraphics.fillStyle(0x111111);
                carGraphics.fillCircle(30, 15, 4); // Centered on main body
                
                // Set texture size to encompass all parts
                carGraphics.generateTexture('car_texture', 60, 30); // Adjusted size for new design

                this.textures.generate('white_pixel', { data: ['#'], pixelWidth: 2, pixelHeight: 2 });
            }

            function create() {
                this.debugText = this.add.text(10, 10, '', { font: '16px Arial', fill: '#fff' }).setDepth(1);
                
                createTrack.call(this);
                
                // Start car inside the track, rotated to face up
                car = this.matter.add.image(450, 570, 'car_texture')
                    .setAngle(-90) // Rotate the right-pointing graphic to face up
                    .setFrictionAir(normalFriction)
                    .setMass(10);

                cursors = this.input.keyboard.createCursorKeys();
                
                this.cameras.main.startFollow(car, true, 0.08, 0.08);
                this.cameras.main.setZoom(1.5);
                
                this.emitter = this.add.particles(0, 0, 'white_pixel', {
                    speed: 10,
                    scale: { start: 0.5, end: 0 },
                    blendMode: 'ADD',
                    lifespan: 400
                });
                this.emitter.startFollow(car);
                this.emitter.stop();
            }

            function createTrack() {
                this.add.rectangle(450, 350, 900, 700, 0x228B22); // Grass
                
                this.add.graphics()
                    .fillStyle(0x444444)
                    .fillRectShape(trackConfig.outer)
                    .fillStyle(0x228B22)
                    .fillRectShape(trackConfig.inner);
            }

            function update() {
                this.debugText.setPosition(this.cameras.main.scrollX + 10, this.cameras.main.scrollY + 10);
                
                const onTrack = trackConfig.outer.contains(car.x, car.y) && !trackConfig.inner.contains(car.x, car.y);
                
                if (onTrack) {
                    car.setFrictionAir(normalFriction);
                    this.debugText.setText([`Speed: ${car.body.speed.toFixed(2)}`, 'On Track']);
                } else {
                    car.setFrictionAir(grassFriction);
                    this.debugText.setText([`Speed: ${car.body.speed.toFixed(2)}`, 'Off Track!']);
                }

                const acceleration = 0.005;
                const steering = 0.03;

                if (cursors.left.isDown) car.setAngularVelocity(-steering);
                else if (cursors.right.isDown) car.setAngularVelocity(steering);
                else car.setAngularVelocity(0);

                if (cursors.up.isDown) {
                    const force = new Phaser.Math.Vector2(Math.cos(car.rotation), Math.sin(car.rotation)).scale(acceleration);
                    car.applyForce(force);
                }

                if (car.body.speed > 0.1 && onTrack) {
                    this.emitter.start();
                } else {
                    this.emitter.stop();
                }
            }
        };
    </script>
</body>
</html>